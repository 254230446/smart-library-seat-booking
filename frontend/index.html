<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êô∫ËÉΩÂõæ‰π¶È¶ÜÂ∫ß‰ΩçÈ¢ÑÁ∫¶Á≥ªÁªü</title>
    <link href="https://cdn.jsdelivr.net/npm/element-plus/dist/index.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            background: #f5f5f5;
        }
        #app {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .seat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .seat-item {
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .seat-available {
            background: #67C23A;
            color: white;
        }
        .seat-occupied {
            background: #F56C6C;
            color: white;
            cursor: not-allowed;
        }
        .seat-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <h1>üèõÔ∏è Êô∫ËÉΩÂõæ‰π¶È¶ÜÂ∫ß‰ΩçÈ¢ÑÁ∫¶Á≥ªÁªü</h1>
            <p v-if="currentUser">Ê¨¢ËøéÔºå{{ currentUser.username }}</p>
            <el-button v-else @click="showLogin = true" type="primary">ÁôªÂΩï</el-button>
        </div>

        <!-- ÁôªÂΩïÂØπËØùÊ°Ü -->
        <el-dialog v-model="showLogin" title="Áî®Êà∑ÁôªÂΩï" width="400px">
            <el-form :model="loginForm">
                <el-form-item label="Áî®Êà∑Âêç">
                    <el-input v-model="loginForm.username"></el-input>
                </el-form-item>
                <el-form-item label="ÂØÜÁ†Å">
                    <el-input v-model="loginForm.password" type="password"></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="showLogin = false">ÂèñÊ∂à</el-button>
                <el-button type="primary" @click="login">ÁôªÂΩï</el-button>
                <el-button @click="showLogin = false; showRegister = true">Ê≥®ÂÜå</el-button>
            </template>
        </el-dialog>

        <!-- Ê≥®ÂÜåÂØπËØùÊ°Ü -->
        <el-dialog v-model="showRegister" title="Áî®Êà∑Ê≥®ÂÜå" width="400px">
            <el-form :model="registerForm">
                <el-form-item label="Áî®Êà∑Âêç">
                    <el-input v-model="registerForm.username" placeholder="ËØ∑ËæìÂÖ•Áî®Êà∑Âêç"></el-input>
                </el-form-item>
                <el-form-item label="ÂØÜÁ†Å">
                    <el-input v-model="registerForm.password" type="password" placeholder="ËØ∑ËæìÂÖ•ÂØÜÁ†Å"></el-input>
                </el-form-item>
                <el-form-item label="Á°ÆËÆ§ÂØÜÁ†Å">
                    <el-input v-model="registerForm.confirmPassword" type="password" placeholder="ËØ∑ÂÜçÊ¨°ËæìÂÖ•ÂØÜÁ†Å"></el-input>
                </el-form-item>
                <el-form-item label="ÈÇÆÁÆ±">
                    <el-input v-model="registerForm.email" placeholder="ËØ∑ËæìÂÖ•ÈÇÆÁÆ±ÔºàÂèØÈÄâÔºâ"></el-input>
                </el-form-item>
            </el-form>
            <template #footer>
                <el-button @click="showRegister = false">ÂèñÊ∂à</el-button>
                <el-button type="primary" @click="register">Ê≥®ÂÜå</el-button>
            </template>
        </el-dialog>

        <!-- ‰∏ªË¶ÅÂäüËÉΩÊ†áÁ≠æÈ°µ -->
        <el-tabs v-model="activeTab" v-if="currentUser">
            <!-- Â∫ß‰ΩçÊµèËßà -->
            <el-tab-pane label="Â∫ß‰ΩçÊµèËßà" name="seats">
                <el-row :gutter="20">
                    <el-col :span="6">
                        <el-select v-model="filterFloor" placeholder="ÈÄâÊã©Ê•ºÂ±Ç" @change="loadSeats">
                            <el-option label="ÂÖ®ÈÉ®Ê•ºÂ±Ç" :value="null"></el-option>
                            <el-option label="1Ê•º" :value="1"></el-option>
                            <el-option label="2Ê•º" :value="2"></el-option>
                            <el-option label="3Ê•º" :value="3"></el-option>
                        </el-select>
                    </el-col>
                    <el-col :span="6">
                        <el-select v-model="filterArea" placeholder="ÈÄâÊã©Âå∫Âüü" @change="loadSeats">
                            <el-option label="ÂÖ®ÈÉ®Âå∫Âüü" :value="null"></el-option>
                            <el-option label="AÂå∫" value="A"></el-option>
                            <el-option label="BÂå∫" value="B"></el-option>
                            <el-option label="CÂå∫" value="C"></el-option>
                            <el-option label="DÂå∫" value="D"></el-option>
                        </el-select>
                    </el-col>
                </el-row>

                <div class="seat-grid">
                    <div v-for="seat in seats" :key="seat.id"
                         :class="['seat-item', seat.status === 'available' ? 'seat-available' : 'seat-occupied']"
                         @click="selectSeat(seat)">
                        <div>{{ seat.seat_number }}</div>
                        <div style="font-size: 12px;">
                            <span v-if="seat.has_power">üîå</span>
                            <span v-if="seat.near_window">ü™ü</span>
                        </div>
                    </div>
                </div>
            </el-tab-pane>

            <!-- Êô∫ËÉΩÊé®Ëçê -->
            <el-tab-pane label="Êô∫ËÉΩÊé®Ëçê" name="recommend">
                <el-card>
                    <h3>ËÆæÁΩÆÊÇ®ÁöÑÂÅèÂ•Ω</h3>
                    <el-form :model="preferences">
                        <el-form-item label="Èù†Á™óÂ∫ß‰Ωç">
                            <el-switch v-model="preferences.near_window"></el-switch>
                        </el-form-item>
                        <el-form-item label="ÈúÄË¶ÅÊèíÂ∫ß">
                            <el-switch v-model="preferences.has_power"></el-switch>
                        </el-form-item>
                        <el-form-item label="Ê•ºÂ±ÇÂÅèÂ•Ω">
                            <el-select v-model="preferences.floor">
                                <el-option label="Êó†ÂÅèÂ•Ω" :value="null"></el-option>
                                <el-option label="1Ê•º" :value="1"></el-option>
                                <el-option label="2Ê•º" :value="2"></el-option>
                                <el-option label="3Ê•º" :value="3"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-button type="primary" @click="getRecommendations">Ëé∑ÂèñÊé®Ëçê</el-button>
                    </el-form>
                </el-card>

                <el-card v-if="recommendations.length > 0" style="margin-top: 20px;">
                    <h3>üìã ‰∏∫ÊÇ®Êé®Ëçê‰ª•‰∏ãÂ∫ß‰Ωç</h3>
                    <el-table :data="recommendations">
                        <el-table-column prop="seat_number" label="Â∫ß‰ΩçÂè∑"></el-table-column>
                        <el-table-column prop="floor" label="Ê•ºÂ±Ç"></el-table-column>
                        <el-table-column prop="area" label="Âå∫Âüü"></el-table-column>
                        <el-table-column prop="score" label="Êé®ËçêÂ∫¶"></el-table-column>
                        <el-table-column label="ÁâπÂæÅ">
                            <template #default="scope">
                                <el-tag v-if="scope.row.has_power" size="small">ÊèíÂ∫ß</el-tag>
                                <el-tag v-if="scope.row.near_window" size="small">Èù†Á™ó</el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column label="Êìç‰Ωú">
                            <template #default="scope">
                                <el-button size="small" @click="bookSeat(scope.row.seat_id)">È¢ÑÁ∫¶</el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </el-card>
            </el-tab-pane>

            <!-- ÊàëÁöÑÈ¢ÑÁ∫¶ -->
            <el-tab-pane label="ÊàëÁöÑÈ¢ÑÁ∫¶" name="mybookings">
                <el-table :data="myBookings">
                    <el-table-column prop="seat_number" label="Â∫ß‰ΩçÂè∑"></el-table-column>
                    <el-table-column prop="start_time" label="ÂºÄÂßãÊó∂Èó¥"></el-table-column>
                    <el-table-column prop="end_time" label="ÁªìÊùüÊó∂Èó¥"></el-table-column>
                    <el-table-column prop="status" label="Áä∂ÊÄÅ"></el-table-column>
                    <el-table-column label="Êìç‰Ωú">
                        <template #default="scope">
                            <el-button v-if="scope.row.status === 'active' && !scope.row.check_in"
                                      size="small" @click="checkIn(scope.row.id)">Á≠æÂà∞</el-button>
                            <el-button v-if="scope.row.status === 'active'"
                                      size="small" type="danger" @click="cancelBooking(scope.row.id)">ÂèñÊ∂à</el-button>
                            <el-button v-if="scope.row.status === 'active' && scope.row.check_in"
                                      size="small" type="success" @click="rateBooking(scope.row.id)">ËØÑ‰ª∑</el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </el-tab-pane>

            <!-- Êï∞ÊçÆÂàÜÊûê -->
            <el-tab-pane label="Êï∞ÊçÆÂàÜÊûê" name="analytics">
                <div class="chart-container">
                    <h3>üìä ‰ªäÊó•Âç†Áî®ÁéáÁªüËÆ°</h3>
                    <div id="occupancyChart" style="height: 400px;"></div>
                </div>

                <div class="chart-container">
                    <h3>üî• ÁÉ≠Èó®Â∫ß‰ΩçTop10</h3>
                    <div id="popularChart" style="height: 400px;"></div>
                </div>
            </el-tab-pane>
        </el-tabs>
    </div>

    <script>
        const { createApp } = Vue;
        const app = createApp({
            data() {
                return {
                    currentUser: null,
                    showLogin: false,
                    showRegister: false,
                    loginForm: { username: '', password: '' },
                    registerForm: {
                        username: '',
                        password: '',
                        confirmPassword: '',
                        email: ''
                    },
                    activeTab: 'seats',
                    seats: [],
                    filterFloor: null,
                    filterArea: null,
                    preferences: {
                        near_window: false,
                        has_power: false,
                        floor: null
                    },
                    recommendations: [],
                    myBookings: []
                }
            },
            mounted() {
                const user = localStorage.getItem('currentUser');
                if (user) {
                    this.currentUser = JSON.parse(user);
                    this.loadSeats();
                    this.loadMyBookings();
                }
            },
            methods: {
                async register() {
                    if (!this.registerForm.username || !this.registerForm.password) {
                        ElementPlus.ElMessage.error('ËØ∑Â°´ÂÜôÁî®Êà∑ÂêçÂíåÂØÜÁ†Å');
                        return;
                    }

                    if (this.registerForm.password !== this.registerForm.confirmPassword) {
                        ElementPlus.ElMessage.error('‰∏§Ê¨°ÂØÜÁ†Å‰∏ç‰∏ÄËá¥');
                        return;
                    }

                    try {
                        const res = await axios.post('http://localhost:5000/api/register', {
                            username: this.registerForm.username,
                            password: this.registerForm.password,
                            email: this.registerForm.email
                        });

                        ElementPlus.ElMessage.success('Ê≥®ÂÜåÊàêÂäüÔºÅËØ∑ÁôªÂΩï');
                        this.showRegister = false;
                        this.showLogin = true;

                        this.registerForm = {
                            username: '',
                            password: '',
                            confirmPassword: '',
                            email: ''
                        };
                    } catch (error) {
                        ElementPlus.ElMessage.error('Ê≥®ÂÜåÂ§±Ë¥•Ôºö' + (error.response?.data?.error || 'ÁΩëÁªúÈîôËØØ'));
                    }
                },

                async login() {
                    try {
                        const res = await axios.post('http://localhost:5000/api/login', this.loginForm);
                        this.currentUser = res.data.user;
                        localStorage.setItem('currentUser', JSON.stringify(res.data.user));
                        this.showLogin = false;
                        this.loadSeats();
                        ElementPlus.ElMessage.success('ÁôªÂΩïÊàêÂäüÔºÅ');
                    } catch (error) {
                        ElementPlus.ElMessage.error('ÁôªÂΩïÂ§±Ë¥•Ôºö' + (error.response?.data?.error || 'ÁΩëÁªúÈîôËØØ'));
                    }
                },

                async loadSeats() {
                    const params = {};
                    if (this.filterFloor) params.floor = this.filterFloor;
                    if (this.filterArea) params.area = this.filterArea;

                    const res = await axios.get('http://localhost:5000/api/seats', { params });
                    this.seats = res.data;
                },

                selectSeat(seat) {
                    if (seat.status !== 'available') {
                        ElementPlus.ElMessage.warning('ËØ•Â∫ß‰Ωç‰∏çÂèØÁî®');
                        return;
                    }
                    this.bookSeat(seat.id);
                },

                async getRecommendations() {
                    try {
                        const res = await axios.post('http://localhost:5000/api/recommend', {
                            user_id: this.currentUser.id,
                            filters: this.preferences,
                            n: 5
                        });
                        this.recommendations = res.data;
                        ElementPlus.ElMessage.success('Â∑≤‰∏∫ÊÇ®ÁîüÊàê‰∏™ÊÄßÂåñÊé®ËçêÔºÅ');
                    } catch (error) {
                        ElementPlus.ElMessage.error('Ëé∑ÂèñÊé®ËçêÂ§±Ë¥•');
                    }
                },

                async bookSeat(seatId) {
                    const start = new Date();
                    const end = new Date(start.getTime() + 2 * 60 * 60 * 1000);

                    try {
                        await axios.post('http://localhost:5000/api/bookings', {
                            user_id: this.currentUser.id,
                            seat_id: seatId,
                            start_time: start.toISOString(),
                            end_time: end.toISOString()
                        });
                        ElementPlus.ElMessage.success('È¢ÑÁ∫¶ÊàêÂäüÔºÅ');
                        this.loadMyBookings();
                        this.loadSeats();
                    } catch (error) {
                        ElementPlus.ElMessage.error('È¢ÑÁ∫¶Â§±Ë¥•Ôºö' + (error.response?.data?.error || 'ÁΩëÁªúÈîôËØØ'));
                    }
                },

                async loadMyBookings() {
                    const res = await axios.get(`http://localhost:5000/api/bookings/${this.currentUser.id}`);
                    this.myBookings = res.data;
                },

                async cancelBooking(bookingId) {
                    await axios.post(`http://localhost:5000/api/bookings/${bookingId}/cancel`);
                    ElementPlus.ElMessage.success('Â∑≤ÂèñÊ∂àÈ¢ÑÁ∫¶');
                    this.loadMyBookings();
                },

                async checkIn(bookingId) {
                    await axios.post(`http://localhost:5000/api/bookings/${bookingId}/checkin`);
                    ElementPlus.ElMessage.success('Á≠æÂà∞ÊàêÂäüÔºÅ');
                    this.loadMyBookings();
                },

                async rateBooking(bookingId) {
                    const rating = await ElementPlus.ElMessageBox.prompt('ËØ∑‰∏∫Â∫ß‰ΩçÊâìÂàÜ (1-5)', 'ËØÑ‰ª∑', {
                        inputPattern: /^[1-5]$/,
                        inputErrorMessage: 'ËØ∑ËæìÂÖ•1-5ÁöÑÊï∞Â≠ó'
                    });

                    await axios.post(`http://localhost:5000/api/bookings/${bookingId}/rate`, {
                        rating: parseInt(rating.value)
                    });
                    ElementPlus.ElMessage.success('ËØÑ‰ª∑ÊàêÂäüÔºÅ');
                    this.loadMyBookings();
                },

                async loadOccupancyChart() {
                    const res = await axios.get('http://localhost:5000/api/analytics/occupancy');
                    const data = res.data;

                    const chart = echarts.init(document.getElementById('occupancyChart'));
                    chart.setOption({
                        xAxis: {
                            type: 'category',
                            data: data.map(d => d.hour)
                        },
                        yAxis: {
                            type: 'value',
                            name: 'Âç†Áî®Áéá(%)'
                        },
                        series: [{
                            data: data.map(d => d.rate),
                            type: 'line',
                            smooth: true,
                            areaStyle: {}
                        }]
                    });
                },

                async loadPopularChart() {
                    const res = await axios.get('http://localhost:5000/api/analytics/popular-seats');
                    const data = res.data;

                    const chart = echarts.init(document.getElementById('popularChart'));
                    chart.setOption({
                        xAxis: {
                            type: 'category',
                            data: data.map(d => d.seat_number)
                        },
                        yAxis: {
                            type: 'value',
                            name: 'È¢ÑÁ∫¶Ê¨°Êï∞'
                        },
                        series: [{
                            data: data.map(d => d.booking_count),
                            type: 'bar'
                        }]
                    });
                }
            },
            watch: {
                activeTab(val) {
                    if (val === 'analytics') {
                        this.$nextTick(() => {
                            this.loadOccupancyChart();
                            this.loadPopularChart();
                        });
                    }
                }
            }
        });

        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>
